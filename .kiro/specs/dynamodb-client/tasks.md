# 実装タスクリスト

## 概要

このタスクリストは、DynamoDBクライアントライブラリの残りの実装タスクを管理します。要件1-24のうち、ほとんどが実装済みですが、アーキテクチャリファクタリングと改善タスクが残っています。

## 実装状況サマリー

### 完了済み（v0.3.6時点）

- ✅ 要件1-12: 基本機能（アーキテクチャ、パッケージ構成、API、Lambda実装）
- ✅ 要件13-17: 自動シャドウ化（v0.3.0で実装）
- ✅ 要件18-23: OSS化（npm公開、CI/CD、ライセンス）

### 実装予定

- 🔄 要件24: アーキテクチャのリファクタリング（新規追加、最優先）

---

## フェーズ1: アーキテクチャリファクタリング（最優先）

### タスク1: 共通モジュールの抽出と整理

**目的**: コードの重複を削除し、共通ロジックを適切に整理する

**詳細**:
- `shared/` ディレクトリの作成
- 共通型定義を `shared/types/` に移動
- 共通エラークラスを `shared/errors/` に作成
- 共通ユーティリティを `shared/utils/` に抽出
- 共通定数を `shared/constants/` に抽出

**参照**: 要件24（アーキテクチャのリファクタリング）

**成果物**:
- `src/shared/types/` - 共通型定義
- `src/shared/errors/` - 統一されたエラー階層
- `src/shared/utils/` - 共通ユーティリティ
- `src/shared/constants/` - 共通定数

**サブタスク**:
- [x] 1.1 `shared/` ディレクトリ構造の作成
- [x] 1.2 共通型定義の移動（client.ts, server.ts, common.ts）
- [x] 1.3 統一されたエラー階層の実装（BaseError, ClientError, ServerError, ValidationError）
- [x] 1.4 共通ユーティリティの抽出（logger.ts, ulid.ts, validation.ts）
- [x] 1.5 共通定数の抽出（http.ts, dynamodb.ts）

**完了日**: 2024-12-22
**成果**: 
- `src/shared/` ディレクトリ構造を作成し、共通モジュールを整理
- 型定義、エラークラス、ユーティリティ、定数を統一的に管理
- 重複コードを削除し、インポートパスを統一
- すべてのテストが正常に通過することを確認

---

### タスク2: 依存関係の整理と循環依存の解消

**目的**: 依存関係を一方向に整理し、循環依存を解消する

**詳細**:
- 現在の依存関係の分析
- 循環依存の特定と解消
- 依存方向の一方向化（integrations → client → server → shadows → shared）
- インターフェースの分離

**参照**: 要件24（アーキテクチャのリファクタリング）

**成果物**:
- 循環依存のない依存関係グラフ
- 明確な層構造

**サブタスク**:
- [x] 2.1 現在の依存関係の分析とドキュメント化
- [x] 2.2 循環依存の特定
- [x] 2.3 循環依存の解消（インターフェース分離、依存性注入）
- [x] 2.4 依存方向の一方向化
- [x] 2.5 依存関係の検証テストの追加

**完了日**: 2024-12-22
**成果**: 
- アーキテクチャドキュメント（`docs/ARCHITECTURE.md`）を作成し、5層構造を明確化
- 循環依存がないことを確認（依存関係検証テストで検証）
- server層がshadows層を正しく使用するように修正（重複コードを削除）
- 依存関係の検証テスト（`__tests__/architecture/dependencies.test.ts`）を追加
- 依存方向が正しいことを確認：integrations → client → server → shadows → shared

---

### タスク3: 大きな関数の分割

**目的**: 50行を超える関数を単一責任の原則に従って分割する

**詳細**:
- 50行を超える関数の特定
- 複数の責任を持つ関数の分析
- 単一責任の原則に基づく分割
- 分割後の関数のテスト更新

**参照**: 要件24（アーキテクチャのリファクタリング）

**成果物**:
- 50行以下の小さな関数群
- 明確な責任を持つ関数

**サブタスク**:
- [x] 3.1 50行を超える関数の特定とリスト化
- [x] 3.2 server/handler.ts の大きな関数の分割
- [x] 3.3 scripts/repair-shadows.ts の大きな関数の分割
- [x] 3.4 共通ユーティリティの抽出
- [x] 3.5 分割後の関数のテスト確認

**完了日**: 2024-12-23
**成果**: 
- `src/server/handler.ts` の `executeOperation` 関数（約200行）を操作ディスパッチャーとパラメータ変換に分割
- `src/scripts/repair-shadows.ts` の `repairAllRecords` 関数（約80行）を単一レコード修復と一括修復に分割
- 認証処理、リクエストパース、レスポンス生成、エラーハンドリングを独立したモジュールに分離
- HTTPタイムアウト値などの重複定数を共通定数ファイルに抽出
- すべてのテストが正常に通過することを確認

---

### タスク4: 重複コードの削除と共通化

**目的**: 3回以上繰り返されるロジックを共通関数として抽出する

**詳細**:
- 重複ロジックの特定
- 共通関数への抽出
- マジックナンバーの定数化
- 共通パターンの標準化

**参照**: 要件24（アーキテクチャのリファクタリング）

**成果物**:
- 重複のない共通化されたコード
- 定数化されたマジックナンバー

**サブタスク**:
- [x] 4.1 重複ロジックの特定とリスト化
- [x] 4.2 HTTP通信関連の共通化（タイムアウト値の定数化）
- [x] 4.3 バリデーション処理の共通化
- [x] 4.4 エラーハンドリングパターンの共通化
- [x] 4.5 マジックナンバーの定数化

**完了日**: 2024-12-23
**成果**: 
- HTTPタイムアウト値（30000）を `DEFAULT_HTTP_TIMEOUT_MS` として共通定数化
- HTTPステータスコードを `HTTP_STATUS` 定数として共通化
- バリデーションエラーメッセージを `VALIDATION_ERROR_MESSAGES` として共通化
- バリデーションエラーパターンを `VALIDATION_ERROR_PATTERNS` として共通化
- 数値フォーマット定数（20桁ゼロ埋め）を `NUMBER_FORMAT` として共通化
- すべてのテストが正常に通過することを確認

---

### タスク5: エラーハンドリングとログ出力の統一

**目的**: 一貫したエラーハンドリングパターンと構造化ログ出力を実装する

**詳細**:
- 統一されたエラー階層の実装
- エラーハンドリングパターンの標準化
- 構造化ログ出力の実装
- エラーコードの体系化

**参照**: 要件24（アーキテクチャのリファクタリング）

**成果物**:
- 統一されたエラーハンドリング
- 構造化されたログ出力

**サブタスク**:
- [x] 5.1 統一されたエラー階層の実装
- [x] 5.2 エラーハンドリングパターンの適用
- [x] 5.3 構造化ログ出力の実装
- [x] 5.4 エラーコードの体系化
- [x] 5.5 ログレベルの設定機能の追加

**完了日**: 2024-12-23
**成果**: 
- 統一されたエラー階層が既に実装済み（AppError、各種エラークラス）
- エラーハンドリングパターンが統一済み（errorHandler.ts）
- 構造化ログ出力が既に実装済み（JSON形式、メタデータ付き）
- エラーコードを体系化（ErrorCode enumに新しいコードを追加）
- ログレベル設定機能が既に実装済み（環境変数LOG_LEVEL）
- すべてのテストが正常に通過することを確認

---

## フェーズ2: ドキュメント改善

### タスク6: API リファレンスの作成

**目的**: 包括的なAPIリファレンスドキュメントを作成する

**詳細**:
- すべてのクライアントAPIメソッドを網羅
- 型定義とパラメータの説明
- 使用例とコードスニペット
- エラーハンドリングのベストプラクティス

**参照**: 要件5（クライアントAPI）

**成果物**:
- `docs/API.md`

**サブタスク**:
- [x] 6.1 認証方式（IAM、Cognito、Token）の詳細な説明
- [x] 6.2 基本的な使用方法とコード例
- [x] 6.3 DynamoClient APIの完全な仕様
- [x] 6.4 Database、Collection、FindCursor APIの詳細
- [x] 6.5 型定義（Filter、UpdateOperators、結果型）の説明
- [x] 6.6 react-admin統合の使用方法
- [x] 6.7 エラーハンドリングとベストプラクティス

**完了日**: 2024-12-23
**成果**: 
- 包括的なAPIリファレンス（`docs/API.md`）を作成
- 3つの認証方式の詳細な説明と使用例
- すべてのクライアントAPIメソッドの完全な仕様
- 型安全なフィルタと更新演算子の詳細
- react-admin統合の実装ガイド
- 実用的なベストプラクティスとコード例
- エラーハンドリングの推奨パターン

---

### タスク7: コントリビューションガイドの作成

**目的**: OSSプロジェクトとしてのコントリビューションガイドを作成する

**詳細**:
- 開発環境のセットアップ方法
- コーディング規約
- プルリクエストのプロセス
- コミットメッセージの規約
- テストの書き方

**参照**: 要件18-23（OSS化）

**成果物**:
- `CONTRIBUTING.md`

---

### タスク8: セキュリティポリシーの作成

**目的**: セキュリティポリシーを明確にする

**詳細**:
- サポートされるバージョン
- 脆弱性の報告方法
- セキュリティアップデートのポリシー
- 責任ある開示のガイドライン

**参照**: 要件18-23（OSS化）

**成果物**:
- `SECURITY.md`

---

## フェーズ3: テストカバレッジの向上

### タスク9: 自動シャドウ化のテスト追加

**目的**: v0.3.0で追加された自動シャドウ化機能のテストカバレッジを向上させる

**詳細**:
- プリミティブ型の切り詰め処理のテスト
- 複合型（array, object）の切り詰め処理のテスト
- 数値のオフセット方式のテスト
- JSONフィールドの正規化のテスト
- id フィールドの除外テスト（v0.3.6）

**参照**: 要件13-17（自動シャドウ化）

**成果物**:
- `__tests__/shadows/auto-shadow.test.ts`
- `__tests__/shadows/truncate.test.ts`
- `__tests__/shadows/normalize.test.ts`

---

### タスク10: エラーハンドリングのテスト追加

**目的**: エラーケースのテストカバレッジを向上させる

**詳細**:
- 範囲外の数値のエラーテスト
- 不正な環境変数のエラーテスト
- 認証エラーのテスト
- DynamoDB操作エラーのテスト

**参照**: 要件1-12（基本機能）

**成果物**:
- `__tests__/errors/validation.test.ts`
- `__tests__/errors/auth.test.ts`
- `__tests__/errors/dynamodb.test.ts`

---

## フェーズ4: パフォーマンス最適化

### タスク11: バルク操作のパフォーマンス最適化

**目的**: createMany, updateMany, deleteMany のパフォーマンスを最適化する

**詳細**:
- バッチ処理のチャンクサイズの最適化
- 並列処理の導入
- タイムアウトリスクの軽減
- メモリ使用量の最適化

**参照**: 要件5（クライアントAPI）

**成果物**:
- パフォーマンステストの追加
- 最適化されたバルク操作の実装

---

### タスク12: シャドウレコード生成の最適化

**目的**: シャドウレコード生成のパフォーマンスを最適化する

**詳細**:
- 不要なシャドウレコードの削減
- 文字列切り詰め処理の最適化
- JSON正規化の最適化
- メモリ使用量の削減

**参照**: 要件13-17（自動シャドウ化）

**成果物**:
- ベンチマークテストの追加
- 最適化されたシャドウ生成の実装

---

## フェーズ5: 機能拡張

### タスク13: クエリビルダーの改善

**目的**: より直感的なクエリビルダーAPIを提供する

**詳細**:
- チェーン可能なクエリビルダー
- 型安全なフィルタ条件
- 複雑な論理演算子のサポート
- クエリの最適化

**参照**: 要件6（フィルタAPI）

**成果物**:
- 改善されたクエリビルダーAPI
- ドキュメントの更新

---

### タスク14: トランザクションサポートの追加

**目的**: DynamoDBトランザクションをサポートする

**詳細**:
- TransactWriteItems のサポート
- TransactGetItems のサポート
- トランザクションAPIの設計
- エラーハンドリング

**参照**: 要件1-12（基本機能）

**成果物**:
- トランザクションAPI
- テストの追加
- ドキュメントの更新

---

## フェーズ6: 監視・ロギング

### タスク15: 構造化ロギングの追加

**目的**: Lambda関数に構造化ロギングを追加する

**詳細**:
- JSON形式のログ出力
- ログレベルの設定
- リクエストIDの追跡
- パフォーマンスメトリクスの記録

**参照**: 要件8（Lambda実装）

**成果物**:
- 構造化ロギングの実装
- ログ設定のドキュメント

---

### タスク16: メトリクスの追加

**目的**: CloudWatch メトリクスを追加する

**詳細**:
- 操作ごとのメトリクス
- エラー率のメトリクス
- レイテンシのメトリクス
- シャドウレコード生成のメトリクス

**参照**: 要件8（Lambda実装）

**成果物**:
- メトリクス収集の実装
- CloudWatch ダッシュボードの設定

---

## フェーズ7: 開発者体験の向上

### タスク17: CLIツールの拡張

**目的**: 開発者向けCLIツールを拡張する

**詳細**:
- スキーマ検証コマンド
- マイグレーションコマンド
- テストデータ生成コマンド
- デバッグコマンド

**参照**: 要件4（シャドー設定の自動生成）

**成果物**:
- 拡張されたCLIツール
- CLIドキュメント

---

### タスク18: VSCode拡張の作成

**目的**: VSCode拡張を作成して開発体験を向上させる

**詳細**:
- スキーマ定義の補完
- クエリビルダーのスニペット
- エラーの診断
- ドキュメントへのクイックアクセス

**参照**: 要件1-23（全体）

**成果物**:
- VSCode拡張
- 拡張のドキュメント

---

## 優先順位

### 最優先（すぐに実施）

1. **タスク1**: 共通モジュールの抽出と整理
2. **タスク2**: 依存関係の整理と循環依存の解消
3. **タスク3**: 大きな関数の分割
4. **タスク4**: 重複コードの削除と共通化
5. **タスク5**: エラーハンドリングとログ出力の統一

### 高優先度（アーキテクチャリファクタリング完了後）

6. タスク6: API リファレンスの作成
7. タスク7: コントリビューションガイドの作成
8. タスク8: セキュリティポリシーの作成

### 中優先度（次のマイナーバージョン）

9. タスク9: 自動シャドウ化のテスト追加
10. タスク10: エラーハンドリングのテスト追加
11. タスク15: 構造化ロギングの追加

### 低優先度（将来のバージョン）

12. タスク11: バルク操作のパフォーマンス最適化
13. タスク12: シャドウレコード生成の最適化
14. タスク13: クエリビルダーの改善
15. タスク14: トランザクションサポートの追加
16. タスク16: メトリクスの追加
17. タスク17: CLIツールの拡張
18. タスク18: VSCode拡張の作成

---

## 注意事項

- すべてのタスクは、既存の機能を壊さないように実装する
- テストカバレッジを維持・向上させる
- ドキュメントを常に最新に保つ
- セマンティックバージョニングに従う
- 破壊的変更はメジャーバージョンアップ時のみ

---

## 次のステップ

1. **アーキテクチャリファクタリング（タスク1-5）を最優先で実施**
   - 共通モジュールの抽出と整理
   - 依存関係の整理と循環依存の解消
   - 大きな関数の分割
   - 重複コードの削除と共通化
   - エラーハンドリングとログ出力の統一

2. **ドキュメント改善（タスク6-8）を実施**
   - API リファレンスの作成
   - コントリビューションガイドの作成
   - セキュリティポリシーの作成

3. **テストカバレッジを80%以上に向上（タスク9-10）**
   - 自動シャドウ化のテスト追加
   - エラーハンドリングのテスト追加

4. **v0.4.0リリースに向けて機能拡張を検討（タスク11-18）**
   - パフォーマンス最適化
   - 機能拡張
   - 開発者体験の向上
