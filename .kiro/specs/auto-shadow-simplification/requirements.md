# 要件定義: 自動シャドウ化の簡素化

## イントロダクション

現在のシャドウ設定は、`shadow.config.json` ファイルで各リソースのソート可能フィールドを手動で指定する必要があります。この方式は柔軟性がある一方で、以下の課題があります：

1. 設定ファイルのメンテナンスが必要
2. 新しいフィールド追加時に設定漏れの可能性
3. JSON設定ファイルの管理が煩雑
4. 環境ごとの設定変更が困難

本機能では、これらの課題を解決するため、**レコードごとに独立したシャドウ生成**を採用します。各レコードは、そのレコードに実際に存在するプリミティブ型フィールドのみを自動的にシャドウ化します。

**重要な仕様**: ソート時に存在しないフィールドでソートした場合、そのフィールドを持たないレコードは結果に含まれません。これは仕様として受け入れます。

## 用語集

- **シャドウレコード**: DynamoDBでGSIなしでソートを実現するための補助レコード
- **プリミティブ型**: string, number, boolean, datetime などの基本型
- **オフセット方式**: 負数を含む数値を文字列としてソート可能にする変換方式
- **ゼロパディング**: 数値を固定桁数の文字列に変換する処理（例: `42` → `"00000000000000000042"`）

## 要件

### 要件1: JSON設定ファイルの廃止

**ユーザーストーリー**: 開発者として、設定ファイルのメンテナンスなしでシャドウレコードを利用したい

#### 受け入れ基準

1. WHEN システムが起動する THEN `shadow.config.json` ファイルを読み込まない
2. WHEN 新しいフィールドを追加する THEN 設定ファイルの更新が不要である
3. WHEN `generate-shadow-config` CLIを実行する THEN エラーメッセージを表示する（廃止されたため）
4. WHEN 既存の `shadow.config.json` が存在する THEN 警告を表示する

### 要件2: 環境変数ベースの設定

**ユーザーストーリー**: インフラ管理者として、Terraform経由でシャドウ設定を管理したい

#### 受け入れ基準

1. WHEN Lambda関数が起動する THEN 環境変数 `ENV` から環境識別子を読み込む（既存、変更なし）
2. WHEN Lambda関数が起動する THEN 環境変数 `REGION` からAWSリージョンを読み込む（既存、変更なし）
3. WHEN Lambda関数が起動する THEN 環境変数 `TABLE_NAME` からDynamoDBテーブル名を読み込む（既存、変更なし）
4. WHEN Lambda関数が起動する THEN 環境変数 `COGNITO_USER_POOL_ID` からCognitoユーザープールIDを読み込む（既存、変更なし）
5. WHEN Lambda関数が起動する THEN 環境変数 `COGNITO_CLIENT_ID` からCognitoクライアントIDを読み込む（既存、変更なし）
6. WHEN Lambda関数が起動する THEN 環境変数 `COGNITO_REGION` からCognitoリージョンを読み込む（既存、変更なし）
7. WHEN Lambda関数が起動する THEN 環境変数 `LOG_LEVEL` からログレベルを読み込む（既存、変更なし）
8. WHEN Lambda関数が起動する THEN 環境変数 `SHADOW_CONFIG` を読み込まない（廃止）
9. WHEN Lambda関数が起動する THEN 環境変数 `SHADOW_STRING_MAX_BYTES` から文字列の最大バイト数を読み込む（新規）
10. WHEN Lambda関数が起動する THEN 環境変数 `SHADOW_NUMBER_PADDING` から数値のパディング桁数を読み込む（新規）
11. WHEN シャドウ設定の環境変数が設定されていない THEN デフォルト値を使用する（100, 20）

### 要件3: レコードごとに独立したシャドウ化

**ユーザーストーリー**: 開発者として、各レコードが持つフィールドのみが自動的にソート可能になってほしい

#### 受け入れ基準

1. WHEN レコードを作成する THEN そのレコードに存在する string 型フィールドに対してシャドウレコードを生成する
2. WHEN レコードを作成する THEN そのレコードに存在する number 型フィールドに対してシャドウレコードを生成する
3. WHEN レコードを作成する THEN そのレコードに存在する boolean 型フィールドに対してシャドウレコードを生成する
4. WHEN レコードを作成する THEN そのレコードに存在する datetime 型フィールドに対してシャドウレコードを生成する
5. WHEN レコードを作成する THEN そのレコードに存在する array 型フィールドに対してシャドウレコードを生成する
6. WHEN レコードを作成する THEN そのレコードに存在する object 型フィールドに対してシャドウレコードを生成する
7. WHEN フィールド名が `__` で始まる THEN シャドウレコードを生成しない（内部メタデータ）
8. WHEN フィールドが null または undefined である THEN シャドウレコードを生成しない
9. WHEN 存在しないフィールドでソートする THEN そのフィールドを持たないレコードは結果に含まれない（仕様）

### 要件4: プリミティブ型の切り詰め処理

**ユーザーストーリー**: 開発者として、長文フィールドでもストレージ効率を保ちながらソートしたい

#### 受け入れ基準

1. WHEN string 型フィールドをシャドウ化する THEN 先頭100バイト（UTF-8）まで切り詰める
2. WHEN string 型が100バイト未満である THEN そのまま使用する
3. WHEN string 型が100バイトを超える THEN マルチバイト文字の境界を考慮して切り詰める
4. WHEN 切り詰め位置がマルチバイト文字の途中である THEN 前の文字境界まで戻る
5. WHEN 環境変数 `SHADOW_STRING_MAX_BYTES` が設定されている THEN その値を使用する

### 要件4.5: 複合型の切り詰め処理

**ユーザーストーリー**: 開発者として、配列やオブジェクトもソート可能にしたい

#### 受け入れ基準

1. WHEN array 型フィールドをシャドウ化する THEN JSON文字列化して先頭200バイト（UTF-8）まで切り詰める
2. WHEN object 型フィールドをシャドウ化する THEN JSON文字列化して先頭200バイト（UTF-8）まで切り詰める
3. WHEN array/object 型が200バイト未満である THEN そのまま使用する
4. WHEN array/object 型が200バイトを超える THEN マルチバイト文字の境界を考慮して切り詰める
5. WHEN 環境変数 `SHADOW_STRING_MAX_BYTES` が設定されている THEN array/object型は2倍の値を使用する

### 要件5: 数値のゼロパディングとオフセット処理

**ユーザーストーリー**: 開発者として、負数を含む数値フィールドを正しくソートしたい

#### 受け入れ基準

1. WHEN 数値フィールドをシャドウ化する THEN 20桁のゼロパディングを適用する
2. WHEN 数値が正の数である THEN オフセット（10^20）を加算してゼロパディングする
3. WHEN 数値が負の数である THEN オフセット（10^20）を加算してゼロパディングする
4. WHEN 数値がゼロである THEN オフセット（10^20）をそのままゼロパディングする
5. WHEN 数値が範囲外（-10^20 ～ +10^20）である THEN エラーをスローする
6. WHEN 環境変数 `SHADOW_NUMBER_PADDING` が設定されている THEN その値を使用する

### 要件6: 後方互換性の維持

**ユーザーストーリー**: 既存ユーザーとして、既存のデータとシステムが引き続き動作してほしい

#### 受け入れ基準

1. WHEN レコードを更新する THEN 古いシャドウレコードを削除し、新しいシャドウレコードを生成する
2. WHEN クエリを実行する THEN 新しいシャドウレコード形式を使用する
3. WHEN 既存のレコードが存在する THEN レコード更新時に自動的に新しい方式でシャドウレコードが生成される

### 要件7: エラーハンドリング

**ユーザーストーリー**: 開発者として、設定エラーや範囲外の値を適切に検出したい

#### 受け入れ基準

1. WHEN 環境変数が不正な値である THEN 起動時にエラーをスローする
2. WHEN 数値が範囲外である THEN レコード作成時にエラーをスローする
3. WHEN 文字列の最大バイト数が不正である THEN 起動時にエラーをスローする
4. WHEN パディング桁数が不正である THEN 起動時にエラーをスローする

### 要件8: JSONフィールドの正規化

**ユーザーストーリー**: 開発者として、JSONフィールドの順序が一貫していてほしい

#### 受け入れ基準

1. WHEN レコードを保存する THEN `id` フィールドが常に先頭に配置される
2. WHEN レコードを保存する THEN `createdAt` フィールドが常に末尾に配置される
3. WHEN レコードを保存する THEN `updatedAt` フィールドが常に末尾（`createdAt` の後）に配置される
4. WHEN レコードを保存する THEN その他のフィールドがアルファベット順に配置される
5. WHEN ネストされたJSONオブジェクトを保存する THEN 同じルールが再帰的に適用される
6. WHEN 配列内のオブジェクトを保存する THEN 各オブジェクトが正規化される

### 要件9: ドキュメントの更新

**ユーザーストーリー**: 開発者として、新しい設定方式を理解したい

#### 受け入れ基準

1. WHEN READMEを読む THEN 環境変数ベースの設定方法が記載されている
2. WHEN READMEを読む THEN 自動シャドウ化のルールが記載されている
3. WHEN READMEを読む THEN 数値のオフセット方式が記載されている
4. WHEN READMEを読む THEN 文字列の切り詰め処理が記載されている
5. WHEN READMEを読む THEN JSONフィールドの正規化ルールが記載されている
6. WHEN READMEを読む THEN 移行ガイドが記載されている
